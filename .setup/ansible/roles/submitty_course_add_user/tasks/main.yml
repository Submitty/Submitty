---
# Assumes that local user accounts already exist.

- name: Add student to submitty users.
  ansible.builtin.expect:
    command: ./adduser.py "{{ username }}"
    chdir: /usr/local/submitty/sbin/
    echo: true
    responses:
      (?m)^User givenname: "{{ username }}"
      (?m)^User preferred name: "{{ firstname }}"
      (?m)^User familyname: "{{ lastname }}"
      (?m)^User email: "{{ email }}"
      (?m)^User password: "{{ password }}"
  become: true
  become_user: root

- name: Add existing students to the course database.
  ansible.builtin.command:
    cmd: ./adduser_course.py "{{ username }}" "{{ semester }}" "{{ course }}" "{{ user_group }}"
    chdir: /usr/local/submitty/sbin/
  register: add_user_result
  become: true
  become_user: root
  changed_when: "'User added' in add_user_result.stdout"
