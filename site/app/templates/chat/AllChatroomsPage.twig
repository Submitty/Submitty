<div class="content">
    <h1> Live Chat </h1>
    {% if user_admin %} <!--only instructors can create chat rooms-->
        <a href='javascript:newChatroomForm()' data-testid="new-chatroom-btn" class="btn btn-primary">New Chatroom</a>
    {% endif %}
    <hr>
    <div class="chatrooms-table-wrapper table-responsive">
        <h2> Chatrooms </h2>
        <table id="chatrooms-table" class="table table-striped">
            {% if user_admin %} <!--instructor's view-->
                <col style="width: 2.5%">
                <col style="width: 5%">
                <col style="width: 20%">
                <col style="width: 35%">
                <col style="width: 12.5%">
                <col style="width: 15%">
                <thead>
                    <tr>
                        <th scope="col" style="text-align: left"></th>
                        <th scope="col" style="text-align: left"></th>
                        <th scope="col">Name</th>
                        <th scope="col">Description</th>
                        <th scope="col"></th>
                        <th scope="col" style="text-align: right"></th>
                    </tr>
                </thead>
                <tbody id="chatroom-list" data-testid="chatroom-list-item">
                    <!-- Vue will render the rows here -->
                </tbody>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Fetch chatroom data from existing JSON script tag
                        const allData = JSON.parse(document.getElementById('all-chatroom-data').textContent);
                        const chatrooms = allData.chatrooms;
                        
                        // Mount Vue component for each chatroom
                        const targetSelector = allData.user_admin ? "#chatroom-list" : "#chatroom-list-student";
                        chatrooms.forEach(chatroom => {
                            window.submitty.render(
                                targetSelector,
                                "component",
                                "chat/ChatroomRow",
                                chatroom,
                                true // append mode
                            );
                        });
                    });
                </script>
            {% else %} <!--student's view-->
                <col style="width: 25%">
                <col style="width: 25%">
                <col style="width: 25%">
                <col style="width: 25%">
                <thead>
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Host</th>
                        <th scope="col">Description</th>
                        <th scope="col" style="text-align: left"></th>
                    </tr>
                </thead>
                <tbody id="chatroom-list-student">
                    <!-- Vue will render the rows here -->
                </tbody>
            {% endif %}
        </table>
    </div>
</div>
<script type="application/json" id="all-chatroom-data">
    {
        "user_admin": {{ user_admin ? 'true' : 'false' }},
        "base_url": {{ base_url | json_encode() | raw() }},
        "chatrooms": [
            {% for chatroom in chatrooms %}
            {% if user_admin or chatroom.isActive() %}
            {
                "id": {{ chatroom.getId() }},
                "description": {{ chatroom.getDescription() | json_encode() | raw() }},
                "title": {{ chatroom.getTitle() | json_encode() | raw() }},
                "hostName": {{ chatroom.getHostName() | json_encode() | raw() }},
                "isAllowAnon": {{ chatroom.isAllowAnon() ? 'true' : 'false' }},
                "isAdmin": {{ user_admin ? 'true' : 'false' }},
                "isActive": {{ chatroom.isActive() ? 'true' : 'false' }},
                "baseUrl": {{ base_url | json_encode() | raw() }},
                "csrfToken": {{ csrf_token | json_encode() | raw() }}
            }{% if not loop.last %},{% endif %}
            {% endif %}
            {% endfor %}
        ]
    }
</script>
{% include('chat/CreateChatroomForm.twig') %}
{% include('chat/EditChatroomForm.twig') %}
