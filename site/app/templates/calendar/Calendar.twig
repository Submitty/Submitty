{% import _self as self %}

<script>
    const gradeables_by_date = {{ gradeables_by_date|json_encode|raw }};
    const curr_year = {{ curr_year }};
    const curr_month = {{ curr_month }};
    const curr_day = {{ curr_day }};
    const instructor_courses = {{ instructor_courses|json_encode|raw }};

    $( document ).ready(function() {
        // Get value of the type dropdown
        const type = $("#calendar-item-type-edit").val();
        // Get cookie for curr the viewed day, month, and year
        cookie_year = parseInt(Cookies.get('calendar_year'));
        cookie_month = parseInt(Cookies.get('calendar_month'));
        cookie_day = parseInt(Cookies.get('calendar_day'));
        if (isNaN(cookie_year)) {
            cookie_year = curr_year;
        }
        if (isNaN(cookie_month)) {
            cookie_month = curr_month;
        }
        if (isNaN(cookie_day)) {
            cookie_day = curr_day;
        }

        // Load the calendar to the correct day
        loadCalendar(cookie_month, cookie_year, cookie_day, type);
        //Color the legend
        if ({{show_legend}} === 1) {
            colorLegend();
        }
    });

    function changeYear(x) {
        const type = $("#calendar-item-type-edit").val();
        Cookies.set('calendar_year', x.value);

        cookie_year = parseInt(Cookies.get('calendar_year'));
        cookie_month = parseInt(Cookies.get('calendar_month'));
        cookie_day = parseInt(Cookies.get('calendar_day'));
        if (isNaN(cookie_year)) {
            cookie_year = view_year;
            Cookies.set('calendar_year', cookie_year);
        }
        if (isNaN(cookie_month)) {
            cookie_month = view_month;
            Cookies.set('calendar_month', cookie_month);
        }
        if (isNaN(cookie_day)) {
            cookie_day = view_day;
            Cookies.set('calendar_day', cookie_day);
        }

        Cookies.set('calendar_year', x.value)

        // Load the calendar to the correct day
        loadCalendar(cookie_month, cookie_year, cookie_day, type);
    }

    function changeMonth(x) {
        const type = $("#calendar-item-type-edit").val();
        Cookies.set('calendar_month', x.value);

        cookie_year = parseInt(Cookies.get('calendar_year'));
        cookie_month = parseInt(Cookies.get('calendar_month'));
        cookie_day = parseInt(Cookies.get('calendar_day'));
        if (isNaN(cookie_year)) {
            cookie_year = view_year;
            Cookies.set('calendar_year', cookie_year);
        }
        if (isNaN(cookie_month)) {
            cookie_month = view_month;
            Cookies.set('calendar_month', cookie_month);

        }
        if (isNaN(cookie_day)) {
            cookie_day = view_day;
            Cookies.set('calendar_day', cookie_day);
        }

        
        // Load the calendar to the correct day
        loadCalendar(cookie_month, cookie_year, cookie_day, type);
    }


    function changeView(x) {
        Cookies.set('view',x.value);

        cookie_year = parseInt(Cookies.get('calendar_year'));
        cookie_month = parseInt(Cookies.get('calendar_month'));
        cookie_day = parseInt(Cookies.get('calendar_day'));
        if (isNaN(cookie_year)) {
            cookie_year = view_year;
            Cookies.set('calendar_year', cookie_year);
        }
        if (isNaN(cookie_month)) {
            cookie_month = view_month;
            Cookies.set('calendar_month', cookie_month);
        }
        if (isNaN(cookie_day)) {
            cookie_day = view_day;
            Cookies.set('calendar_day', cookie_day);
        }
        // Load the calendar to the correct day
        loadCalendar(cookie_month, cookie_year, cookie_day, x.value);
    }
</script>


{# Begin Calendar #}
<div class="content">
    <h1>Calendar</h1>
    <div class="cal-content">
        <div class="cal-toolbar">
            {% if instructor_courses|length > 0 %}
                <button type="button" onclick="openNewItemModal()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Item
                </button>
            {% endif %}
                <button type="button" onclick="openOptionsModal()" class="btn btn-primary">
                    <i class="fas fa-sliders"></i> Options
                </button>
                <select id="calendar-year-type-edit" name="type" onchange="changeYear(this);">
                    {% set startYear = curr_year - 20 %}
                    {% set endYear = curr_year + 20 %}

                    {% for year in startYear..endYear%}
                        <option value = "{{ year }}" {% if (year_cookie is defined) and year_cookie == year %} selected {% endif %}> {{year}} </option>
                    {% endfor %}
                </select>
                <select id="calendar-month-type-edit" name="type" onchange="changeMonth(this);">
                    <option value = 1 {% if (month_cookie is defined) and month_cookie == 1 %} selected {% endif %}>January</option>
                    <option value = 2 {% if (month_cookie is defined) and month_cookie == 2 %} selected {% endif %}>February</option>
                    <option value = 3 {% if (month_cookie is defined) and month_cookie == 3 %} selected {% endif %}>March</option>
                    <option value = 4 {% if (month_cookie is defined) and month_cookie == 4 %} selected {% endif %}>April</option>
                    <option value = 5 {% if (month_cookie is defined) and month_cookie == 5 %} selected {% endif %}>May</option>
                    <option value = 6 {% if (month_cookie is defined) and month_cookie == 6 %} selected {% endif %}>June</option>
                    <option value = 7 {% if (month_cookie is defined) and month_cookie == 7 %} selected {% endif %}>July</option>
                    <option value = 8 {% if (month_cookie is defined) and month_cookie == 8 %} selected {% endif %}>August</option>
                    <option value = 9 {% if (month_cookie is defined) and month_cookie == 9 %} selected {% endif %}>September</option>
                    <option value = 10 {% if (month_cookie is defined) and month_cookie == 10 %} selected {% endif %}>October</option>
                    <option value = 11 {% if (month_cookie is defined) and month_cookie == 11 %} selected {% endif %}>November</option>
                    <option value = 12 {% if (month_cookie is defined) and month_cookie == 12%} selected {% endif %}>December</option>
                </select>
                <select id="calendar-item-type-edit" name="type" onchange="changeView(this);">
                    <option value="month" {% if (view_cookie is defined) and view_cookie == "month" %} selected {% endif %}>Month</option>
                    <option value="two_week" {% if (view_cookie is defined)  and view_cookie == "two_week" %} selected {% endif %}>Two Week</option>
                    <option value="one_week" {% if (view_cookie is defined)  and view_cookie == "one_week" %} selected {% endif %}>One Week</option>
                </select>
        </div>

        {# Legend #}
        {% if show_legend == 1 %}
        <div class="cal-legend">
            {% if show_all_cookie == 1 %}
                {% for course in course_names %}
                    <div name="{{course.course_name|replace({' ':''})}}" class="legend-color"></div>
                    <p for="{{course.course_name|replace({' ':''})}}-color" class="legend-label">{{course.display_name}}</p>
                {% endfor %}
            {% else %}
                <div name="{{calendar_course_cookie|replace({' ':''})}}" class="legend-color"></div><p for="{{calendar_course_cookie|replace({' ':''})}}-color" class="legend-label">{{calendar_course_cookie}}</p>
            {% endif %}
        </div>
        {% endif %}

        <div class="calendar" style='margin-bottom: 20px;' id="full-calendar">
            {# Replace by js function call #}
        </div>
    </div>

    {% if show_table == 1 %}
    {# List items in table #}
        <div class="lst-content">
            {% if gradeables_by_section|length > 0 %}
                <div id="gradeables">
                {% for section_num, info in gradeables_by_section %}
                    <div style="margin-bottom: 20px">
                        <div id="{{ info.section_id }}" class="course-section-heading">
                            <div class="course-section-title">
                                {{ info.title }}
                                {% if info.subtitle != "" %}
                                    &nbsp;&nbsp;<em>{{ info.subtitle }}</em>
                                {% endif %}
                            </div>
                        </div>

                        <table class="table table-striped table-bordered persist-area mobile-table" style="text-align: left" id="calendar-list">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Gradeable</th>
                                    <th>Submission Closes</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for id, gradeable in info.gradeables %}
                                <tr>
                                    <td>{{ gradeable.course }}</td>
                                    <td><a href="{{ gradeable.url }}">{{ gradeable.title }}</a></td>
                                    <td>{{ gradeable.submission }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="container">
                    <p>{{ empty_message }}</p>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>



{{ include('calendar/NewCalendarItem.twig') }}
{{ include('calendar/EditCalendarItem.twig') }}
{{ include('calendar/CalendarOptions.twig') }}
