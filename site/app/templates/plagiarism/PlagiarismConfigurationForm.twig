<div class="content">
    <h1>Plagiarism Detection Configuration -- WORK IN PROGRESS</h1>

    <div id="save-configuration-form">
        <form method="post" action="{{ form_action_link }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Select Gradeable:</div>
                <div class="plag-data">

                    {% if new_or_edit == "new" %}
                        <select name="gradeable_id">
                            {% for gradeable_id_title in gradeable_ids_titles %}
                                <option value="{{ gradeable_id_title['g_id'] }}">{{ gradeable_id_title['g_title'] }} (Due {{ gradeable_id_title['g_grade_due_date'] }})</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        {{ title }}
                    {% endif %}

                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">
                    Instructor Provided Code:
                </div>
                <div class="plag-data">
                    <span class="radio-label-pair">
                        <input type="radio" id="no-code-provided-id" value="no_code_provided" name="provided_code_option" {{ provided_code ? "" : "checked" }} >
                        <label for="no-code-provided-id">No</label>
                    </span>
                    <span class="radio-label-pair">
                        <input type="radio" id="code-provided-id" value="code_provided" name="provided_code_option" {{ provided_code ? "checked" : "" }}>
                        <label for="code-provided-id">Yes</label>
                    </span>
                </div>
                <div class="low-margin-top"><input id="provided-code-file" type="file" name="provided_code_file"></div>
                {% if new_or_edit == "edit" and provided_code %}
                    <div id="current-code-file">
                        <br />
                        <div>Current Provided Code:</div>
                        {% for file_name in provided_code_filenames %}
                            <div>{{ file_name }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Version:</div>
                <div class="plag-data">
                    <span class="radio-label-pair">
                        <input type="radio" id="all-version-id" value="all_versions" name="version_option" {{ version == "all_versions" ? "checked" : "" }} >
                        <label for="all-version-id">All Versions</label>
                    </span>
                    <span class="radio-label-pair">
                        <input type="radio" id="active-version-id" value="active_version" name="version_option" {{ version == "all_versions" ? "" : "checked" }}>
                        <label for="active-version-id">Only Active Version</label>
                    </span>
                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Files to be Compared:</div>
                <div class="plag-data">
                    <div id="files-to-be-compared">
                        <span class="option-alt">
                            <a target=_blank href="https://submitty.org/instructor/course_management/plagiarism">How do I specify a regex expression?
                                <i style="font-style: normal;" class="fa-question-circle"></i>
                            </a>
                        </span>
                        <span class="right">
                            <span class="radio-label-pair">
                                <input type="checkbox" id="regex-submissions-dir" name="regex_dir[]" value="submissions" {{ "submissions" in regex_dirs ? "checked" : ""}} />
                                <label for="regex-submissions-dir">Submissions</label>
                            </span>
                            <span class="radio-label-pair">
                                <input type="checkbox" id="regex-results-dir" name="regex_dir[]" value="results" {{ "results" in regex_dirs ? "checked" : "" }} />
                                <label for="regex-results-dir">Results</label>
                            </span>
                            <span class="radio-label-pair">
                                <input type="checkbox" id="regex-checkout-dir" name="regex_dir[]" value="checkout" {{ "checkout" in regex_dirs ? "checked" : "" }} />
                                <label for="regex-checkout-dir">Checkout</label>
                            </span>
                        </span>
                        <input type="text" id="regex-to-select-files" name="regex_to_select_files" class="low-margin-top" value="{{ regex }}" placeholder="Leave blank to select all files"/>
                    </div>
                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Language:</div>
                <div class="plag-data">
                    <select name="language">
                        <option value="plaintext" {{ language["plaintext"] }}>Plain Text</option>
                        <option value="python" {{ language["python"] }}>Python</option>
                        <option value="cpp" {{ language["cpp"] }}>C++</option>
                        <option value="java" {{ language["java"] }}>Java</option>
                        <option value="mips" {{ language["mips"] }}>MIPS Assembly</option>
                    </select>
                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Common Code Threshold:</div>
                <label for="threshold">More than this number of students with matching code will be considered common code</label>
                <div class="plag-data">
                    <input type="number" id="threshold" name="threshold" value="{{ threshold }}" min="2"/>
                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Sequence Length:</div>
                <label for="sequence-length">This is the minimum size of matching regions</label>
                <div class="plag-data">
                    <input type="number" id="sequence-length" name="sequence_length" value="{{ sequence_length }}" placeholder="(Required)" min="1"/>
                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Prior Terms Gradeables:</div>
                <div class="plag-data">
                    <span class="radio-label-pair">
                        <input type="radio" id="no-past-terms-id" value="no_past_terms" name="past_terms_option" {{ prior_terms ? "" : "checked" }}>
                        <label for="no-past-terms-id">No</label>
                    </span>
                    <span class="radio-label-pair">
                        <input type="radio" id="past-terms-id" value="past_terms" name="past_terms_option" {{ prior_terms ? "checked" : "" }}>
                        <label for="past-terms-id">Yes</label>
                    </span>
                    <div class="past-terms-wrapper" id="prev-gradeable-div">
                        <div id="add-more-prev-gradeable" class="add-more" aria-label="Add more">
                            <i class="fas fa-plus-square"></i>Add more
                        </div>
                        {% if new_or_edit == "edit" %}
                            {# TODO: add the rest of the semester/course for each semester_course dropdown #}
                            {% for semester_course, gradeable in prior_term_gradeables %}
                                <div id="prior_g_option_{{ loop_index0 }}">
                                    <select name="prior_semester_course[]" onchange="getGradeables(this)">
                                        {% set tokens = semester_course|split(' ') %}
                                        <option value="{{ semester_course }}">{{ tokens[0] }}, {{ tokens[1] }}</option>
                                    </select>
                                    <select name="prior_gradeable[]">
                                        <option value="{{ gradeable }}">{{ gradeable }}</option>
                                    </select>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {##################################################################}
            <div class="plag-data-group">
                <div class="plag-data-label">Users to be Ignored:</div>
                <div class="plag-data radio-label-pair">
                    <input type="checkbox" id="ignore-instructors" value="ignore_instructors" name="ignore_submission_option[]" {{ "instructors" in ignore_submissions ? "checked" : "" }}>
                    <label for="ignore-instructors">Instructors</label>
                </div>
                <div class="plag-data radio-label-pair">
                    <input type="checkbox" id="ignore-full-access-graders" value="ignore_full_access_graders" name="ignore_submission_option[]" {{ "full_access_graders" in ignore_submissions ? "checked" : "" }}>
                    <label for="ignore-full-access-graders">Full Access Graders</label>
                </div>
                <div class="plag-data radio-label-pair">
                    <input type="checkbox" id="ignore-limited-access-graders" value="ignore_limited_access_graders" name="ignore_submission_option[]" {{ "limited_access_graders" in ignore_submissions ? "checked" : "" }}>
                    <label for="ignore-limited-access-graders">Limited Access Graders</label>
                </div>
                <div class="plag-data radio-label-pair" id="ignore-others-container">
                    <input type="checkbox" id="ignore-others" value="ignore_others" name="ignore_submission_option[]" {{ "others" in ignore_submissions ? "checked" : "" }}>
                    <label for="ignore-others">Others:</label>
                    <input type="text" id="ignore-others-list" value="{{ ignore_submissions_list }}" placeholder="List user ID's separated by commas and spaces" name="ignore_others_list">
                </div>
            </div>
            {##################################################################}
            <div>
                <a href="{{ plagiarism_link }}" class="btn btn-danger">Cancel</a>
                <input class="btn btn-primary" type="submit" value="Save Configuration" />
            </div>
        </form>
    </div>
</div>

<script>
    const form = $("#save-configuration-form");

    // PROVIDED CODE ///////////////////////////////////////////////////////////
    $("#no-code-provided-id").change(function() {
        $("#current-code-file").hide();
        $("#provided-code-file").hide();
    });

    $("#code-provided-id").change(function() {
        $("#current-code-file").show();
        $("#provided-code-file").show();
    });

    $(document).ready(function() {
        if ({{ provided_code ? "true" : "false" }} && $("#code-provided-id").is(":checked")) {
            $("#current-code-file").show();
            $("#provided-code-file").show();
        }
    });

    // PRIOR TERM GRADEABLES ///////////////////////////////////////////////////
    $('#add-more-prev-gradeable', form).on('click', function(){
        addMorePriorTermGradeable();
    });

    $("#no-past-terms-id").change(function() {
        $(".past-terms-wrapper").hide();
    });

    $("#past-terms-id").change(function() {
        $(".past-terms-wrapper").show();
    });

    function getGradeables(selectObject) {
        let semester_course_dropdown = $(selectObject);
        let gradeable_dropdown = $(selectObject).siblings().first();
        gradeable_dropdown.empty();
        if (semester_course_dropdown.val() === "") {
            gradeable_dropdown.append("<option value=''>None</option>");
        } else {
            gradeable_dropdown.append("<option value=''>Loading...</option>");
            $.ajax({
                url: "{{ base_url }}" + "/getPriorGradeables",
                type: "POST",
                data: {
                    csrf_token: csrfToken,
                    semester_course: semester_course_dropdown.val()
                },
                success: function(data) {
                    // TODO: check for fail vs. success message returned from JSON response
                    gradeable_dropdown.empty();
                    let parsed_result = JSON.parse(data);
                    $.each(parsed_result.data, function(index, gradeable) {
                        gradeable_dropdown.append("<option value='" + gradeable + "'>" + gradeable + "</option>");
                    });
                },
                error: function(e) {
                    gradeable_dropdown.empty();
                    gradeable_dropdown.append("<option value=''>Error: Ajax request failed</option>");
                }
            });
        }
    }

    function addMorePriorTermGradeable() {
        const form = $("#save-configuration-form");
        // TODO: assign different indices to divs
        $('#prev-gradeable-div', form).append(`
            <div id='prior_g_option_0'>
                <select name='prior_semester_course[]' onchange='getGradeables(this)'>
                    <option value=''>Loading...</option>
                </select>
                <select name='prior_gradeable[]'>
                    <option value=''>None</option>
                </select>
            </div>
        `);
        let semester_course_dropdown = $("#prior_g_option_0").children().first();
        $.ajax({
            url: "{{ base_url }}" + "/getPriorSemesterCourses",
            type: "GET",
            data: { csrf_token: csrfToken },
            success: function(data) {
                // TODO: check for fail vs. success message returned from JSON response
                semester_course_dropdown.empty();
                let parsed_result = JSON.parse(data);
                $.each(parsed_result.data, function(index, semester_course) {
                    let tokens_array = semester_course.split(" ");
                    semester_course_dropdown.append("<option value='" + tokens_array[0] + "_" + tokens_array[1] + "'>" + tokens_array[0] + " " + tokens_array[1] + "</option>");
                });
                getGradeables(semester_course_dropdown[0]);
            },
            error: function(e) {
                semester_course_dropdown.empty();
                semester_course_dropdown.append("<option value=''>Error: Ajax request failed</option>");
            }
        });
    }

    // LANGUAGE, SEQUENCE LENGTH, THRESHOLD ////////////////////////////////////
    $('[name="threshold"], [name="sequence_length"]').change(function(){
        if($(this).val().length === 0){
            $(this)[0].setCustomValidity('Input is required');
        }
        else if(!(/^[\d]+$/g).test($(this).val())){
            $(this)[0].setCustomValidity('Input must only contain numeric characters');
        } else {
            $(this)[0].setCustomValidity('');
        }
    });

    $("select[name='language']").change(function() {
        var form = $("#save-configuration-form")
        // Following code is used to set default window size for different languages
        // that will appear in 'configureNewGradeableForPlagiarismForm'
        // to change the default values, just change the val attribute for the language.

        if ($('[name="language"]', form).val() == "python") {
            $('[name="sequence_length"]', form).val('10');
        }
        else if ($('[name="language"]', form).val() == "cpp") {
            $('[name="sequence_length"]', form).val('2');
        }
        else if ($('[name="language"]', form).val() == "java") {
            $('[name="sequence_length"]', form).val('3');
        }
        else if ($('[name="language"]', form).val() == "plaintext") {
            $('[name="sequence_length"]', form).val('4');
        }
        else if ($('[name="language"]', form).val() == "mips") {
            $('[name="sequence_length"]', form).val('5');
        }
    });
</script>
