{% for stylesheet in localcss %}
    <link rel="stylesheet" type="text/css" href="{{ stylesheet }}"/>
{% endfor %}
{# MarkerJS scripts are now loaded globally in the main TA grading page #}
{% for script in localjs %}
    <script src="{{ script }}"></script>
{% endfor %}

<div id="image-content-wrapper">
    <div id="image-viewer" class="imageViewer">
        <div id="image-error-message" style="display: none; color: red; font-weight: bold; padding: 10px; text-align: center;"></div>
        
        <div class="image-annotation-container">
            <img id="annotatable-image" 
                 src="{{ display_file_url }}?dir={{ directory }}&file={{ filename | url_encode }}&path={{ file_path | url_encode }}&ta_grading=true&gradeable_id={{ gradeable_id }}" 
                 alt="{{ filename }}" />
            
            <div class="annotation-toolbar">
                <button id="add-annotations-btn" class="btn btn-primary" onclick="if (typeof addAnnotations === 'function') addAnnotations();">
                    <i class="fas fa-edit"></i> Edit Annotations
                </button>
                <button id="save-annotations-btn" class="btn btn-success" onclick="if (typeof saveAnnotations === 'function') saveAnnotations();">
                    <i class="fas fa-save"></i> Save Annotations
                </button>
                <button id="clear-annotations-btn" class="btn btn-warning" onclick="if (typeof clearAnnotations === 'function') clearAnnotations();">
                    <i class="fas fa-eraser"></i> Clear Annotations
                </button>
                
                {% if can_download %}
                    <button id="download-image-btn" class="btn btn-secondary" onclick="if (typeof downloadImage === 'function') downloadImage();">
                        <i class="fas fa-download"></i> Download Image
                    </button>
                {% endif %}
                
                <span id="annotation-status"></span>
            </div>
            
            <!-- Hidden data elements -->
            <div id="annotation-data" style="display: none;">
                <input type="hidden" id="gradeable-id" value="{{ gradeable_id }}" />
                <input type="hidden" id="user-id" value="{{ user_id }}" />
                <input type="hidden" id="grader-id" value="{{ grader_id }}" />
                <input type="hidden" id="filename" value="{{ filename }}" />
                <input type="hidden" id="file-path" value="{{ file_path }}" />
                <input type="hidden" id="csrf-token" value="{{ csrfToken }}" />
                <input type="hidden" id="existing-annotations" value="{{ annotation_jsons[grader_id] | default('[]') }}" />
                <input type="hidden" id="all-annotations" value="{{ annotation_jsons | json_encode }}" />
                <input type="hidden" id="is-student" value="{{ student_popup ? 'true' : 'false' }}" />
            </div>
        </div>
    </div>
</div>

<script defer>
    $(()=>{
        window.initImageAnnotation("{{ gradeable_id }}", "{{ user_id }}", "{{ grader_id }}", "{{ filename | e('js') }}", "{{ file_path | e('js') }}", "{{ csrfToken }}", {{ student_popup ? 'true' : 'false' }}, {{ annotation_jsons[grader_id] | default('[]') | raw }});
    })
</script>